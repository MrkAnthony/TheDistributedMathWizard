<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Math Wizard Controller</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    
    <style>
        body { padding: 2rem; background-color: #11191f; }
        .container { max-width: 600px; }
        .result-box { 
            padding: 1rem; border-radius: 8px; margin-top: 1rem; 
            border: 1px solid #333; background: #1a2632; 
        }
        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; padding: 8px 0; font-size: 0.9rem;
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #888; }
        .node-id { font-family: monospace; color: #4caf50; }
        
        .status-badge {
            font-weight: bold; padding: 2px 8px; border-radius: 4px;
            background: #333; color: #fff;
        }
        [x-cloak] { display: none !important; }
    </style>

    <script>
        function wizardApp() {
            return {
                a: null, b: null,
                processing: false,
                status: 'IDLE', 
                result: null,
                error: '',
                message: false, 

                // Tracking Identities
                startedBy: '---',    // Who accepted the request
                checkedBy: '---',    // Who we polled last
                processedBy: '---',  // Who actually did the math

                get inputsValid() { return this.a !== null && this.b !== null; },

                resetUI() {
                    this.result = null; 
                    this.error = ''; 
                    this.message = true; 
                    this.processing = true;
                    
                    // Reset Identities
                    this.startedBy = '---';
                    this.checkedBy = '---';
                    this.processedBy = 'Waiting...';
                },

                // 1. DIRECT SYNC ROUTE
                async directAdd() {
                    this.resetUI();
                    this.status = 'Fetching...';
                    
                    try {
                        console.log(`[UI] Starting Direct Add: a=${this.a}, b=${this.b}`);
                        
                        const res = await fetch(`/add?a=${this.a}&b=${this.b}`);
                        const data = await res.json();
                        
                        console.log('[API] /add Response:', data);

                        this.result = data.sum;
                        this.status = 'complete';
                        
                        // In sync mode, one node does everything
                        const nodeId = data.handled_by || 'Unknown';
                        this.startedBy = nodeId;
                        this.checkedBy = nodeId;
                        this.processedBy = nodeId;

                    } catch (e) {
                        console.error('[API] /add Failed:', e);
                        this.error = "Request Failed";
                        this.status = 'failed';
                    } finally {
                        this.processing = false;
                    }
                },

                // 2. ASYNC POLLING ROUTE
                async startBackgroundTask() {
                    this.resetUI();
                    this.status = 'starting';

                    try {
                        console.log(`[UI] Creating Background Task: a=${this.a}, b=${this.b}`);

                        // A. Create Task
                        const res = await fetch(`/task?a=${this.a}&b=${this.b}&operation=add`, { method: 'POST' });
                        const data = await res.json();
                        
                        console.log('[API] /task Created:', data);
                        
                        // Capture who STARTED the task
                        this.startedBy = data.handled_by || 'Unknown';
                        this.status = 'pending';
                        
                        // B. Start Polling
                        this.poll(data.task_id);

                    } catch (e) {
                        console.error('[API] /task Creation Failed:', e);
                        this.error = "Could not start task";
                        this.status = 'failed';
                        this.processing = false;
                    }
                },

                async poll(taskId) {
                    try {
                        const res = await fetch(`/tasks/${taskId}/status`);
                        const data = await res.json();

                        console.log(`[API] Poll Status (${taskId}):`, data);

                        // 1. ALWAYS update who checked it (The API Node)
                        this.checkedBy = data.checked_by || 'Unknown';

                        if (data.status === 'complete') {
                            this.result = data.result;
                            this.status = 'complete';
                            
                            // 2. ONLY update processedBy when finished (The Worker)
                            this.processedBy = data.handled_by || 'Unknown';
                            
                            this.processing = false;
                            console.log('[UI] Task Finished Successfully. Worker:', this.processedBy);
                        } 
                        else if (data.status === 'failed') {
                            this.error = data.error;
                            this.status = 'failed';
                            this.processedBy = data.handled_by || 'Error Worker';
                            this.processing = false;
                            console.warn('[UI] Task Failed on Server');
                        } 
                        else {
                            // Still pending...
                            console.log(`[UI] Task pending. Checked by API Node: ${this.checkedBy}`);
                            setTimeout(() => this.poll(taskId), 2000);
                        }
                    } catch (e) {
                        console.error('[API] Polling Error:', e);
                        this.error = "Polling Error";
                        this.processing = false;
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body x-data="wizardApp()">

    <main class="container">
        <h2>üßô Distributed Math Wizard</h2>
        
        <div class="grid">
            <label>Value A <input type="number" x-model.number="a" placeholder="0"></label>
            <label>Value B <input type="number" x-model.number="b" placeholder="0"></label>
        </div>

        <div class="grid">
            <button @click="directAdd()" :disabled="processing || !inputsValid">
                ‚ö° Direct Add
            </button>
            <button class="secondary" @click="startBackgroundTask()" :disabled="processing || !inputsValid">
                ‚è≥ Start Background Task
            </button>
        </div>

        <div x-show="message" class="result-box" x-cloak>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <strong>Output:</strong>
                <span class="status-badge" x-text="status.toUpperCase()"></span>
            </div>

            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                <div class="info-row">
                    <span class="info-label">Initiated By:</span>
                    <span class="node-id" x-text="startedBy"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Checked By:</span>
                    <span class="node-id" x-text="checkedBy"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Processed By:</span>
                    <span class="node-id" x-text="processedBy" style="font-weight:bold;"></span>
                </div>
            </div>

            <progress x-show="status === 'pending'"></progress>

            <h3 x-show="result !== null" style="color: #4caf50; text-align:center; margin: 10px 0;">
                Sum: <span x-text="result"></span>
            </h3>

            <div x-show="error" style="color: #ff6b6b; text-align:center;" x-text="error"></div>
        </div>
    </main>
</body>
</html>